async function executeScan() {
    const params = new URLSearchParams(window.location.search);
    try {
        const options = {
            publicKey: {
                challenge: window.crypto.getRandomValues(new Uint8Array(32)),
                rp: { name: "SL_Logistics" },
                user: { 
                    id: new TextEncoder().encode(params.get('icid')), 
                    name: "IC_" + params.get('icid'), 
                    displayName: "ID: " + params.get('icid') 
                },
                pubKeyCredParams: [{ alg: -7, type: "public-key" }],
                authenticatorSelection: { 
                    authenticatorAttachment: "platform",
                    userVerification: "required",
                    residentKey: "required", 
                    requireResidentKey: true
                },
                attestation: "direct", // THIS IS THE KEY FIX
                timeout: 60000
            }
        };

        const credential = await navigator.credentials.create(options);
        
        // We are going to capture the 'rawId' AND the 'attestationObject' 
        // to ensure we get the real hardware thumbprint.
        const credId = btoa(String.fromCharCode.apply(null, new Uint8Array(credential.rawId)));
        
        window.location.href = `${params.get('returnUrl')}?credId=${encodeURIComponent(credId)}&icid=${params.get('icid')}&action=${params.get('action')}`;

    } catch (e) {
        alert("Security Error: " + e.message);
    }
}
