<!DOCTYPE html>
<html>
<head>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body class="bg-primary text-white">
  <div class="container py-4 text-center">
    <h2 id="st-title">Station: Loading...</h2>
    <div id="status-msg" class="badge bg-light text-dark p-2 mb-3"><?!= statusFromUrl ?></div>
    
    <div class="card shadow p-0 text-dark mx-auto" style="max-width: 600px;">
      <table class="table table-hover mb-0">
        <thead class="table-dark">
          <tr><th>Name</th><th>ID</th><th>Action</th></tr>
        </thead>
        <tbody id="ic-list"></tbody>
      </table>
    </div>
  </div>

  <script>
    const config = <?!= JSON.stringify(getAppConfig()) ?>;
    const params = new URLSearchParams(window.location.search);
    const station = params.get('station') || "AUTO";

    window.onload = function() {
      document.getElementById('st-title').innerText = "Station: " + station;
      refreshList();
    };

    function refreshList() {
      google.script.run.withSuccessHandler(data => {
        const list = document.getElementById('ic-list');
        list.innerHTML = data.map(ic => {
          // LOCK LOGIC: Disable button if already pending
          const isPending = (ic.status === 'PENDING_APPROVAL');
          const isEnrolled = (ic.status === 'ENROLLED');
          
          let btnText = "Onboard";
          let btnClass = "btn-primary";
          let btnDisabled = "";

          if (isPending) {
            btnText = "Pending Approval";
            btnClass = "btn-warning";
            btnDisabled = "disabled";
          } else if (isEnrolled) {
            btnText = "Re-Link";
            btnClass = "btn-outline-secondary";
          }

          return `<tr>
            <td>${ic.name}</td>
            <td>${ic.id}</td>
            <td>
              <button class="btn btn-sm ${btnClass}" ${btnDisabled} onclick="startOnboard('${ic.id}', '${ic.status}')">
                ${btnText}
              </button>
            </td>
          </tr>`;
        }).join('');
      }).getICList(station);
    }

    function startOnboard(id, status) {
      window.location.href = config.githubUrl + "?icid=" + id + "&returnUrl=" + config.execUrl + "&action=onboard&station=" + station + "&status=" + status;
    }
  </script>
</body>
</html>
